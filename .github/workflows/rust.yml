# GitHub Actions for Rust project
#
# This workflow performs the following actions:
# 1.  On every push to `main` or pull request to `main`:
#     - Checks code formatting (`cargo fmt`).
#     - Lints the code (`cross clippy`).
#     - Runs tests (`cross test`).
# 2.  When a tag in the format `v*.*.*` (e.g., `v1.0.0`) is pushed:
#     - Builds a statically linked binary for Linux (`x86_64-unknown-linux-musl`) using `cross`.
#     - Creates a GitHub Release and uploads the binary as an asset.
#
# It uses `Swatinem/rust-cache` to speed up the process and `cross` for robust cross-compilation.

name: Rust CI/CD

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - master

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: tronctl

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-musl

      - name: Install cross
        run: cargo install cross

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: "linux-musl"

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Lint code (Clippy)
        run: cross clippy --target x86_64-unknown-linux-musl -- -D warnings

      - name: Run tests
        run: cross test --all --target x86_64-unknown-linux-musl

  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: build-and-test
    # Only run this job when a `v*` tag is pushed
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-musl

      - name: Install cross
        run: cargo install cross

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: "linux-musl"

      - name: Build for release
        run: cross build --release --target x86_64-unknown-linux-musl

      - name: Package for release
        id: package # Give this step an ID to reference its output
        run: |
          RELEASE_DIR="release"
          mkdir -p $RELEASE_DIR

          # Copy binary
          cp target/x86_64-unknown-linux-musl/release/${{ env.BINARY_NAME }} $RELEASE_DIR/

          # Copy other assets like README and LICENSE
          cp README.md $RELEASE_DIR/
          # Look for a license file (case-insensitive) and copy it if it exists
          if ls -i | grep -iq "license"; then
            cp -i $(ls | grep -i "license") $RELEASE_DIR/
          fi
          
          # Create the archive from the release directory
          VERSION=${{ github.ref_name }}
          ARCHIVE_NAME=${{ env.BINARY_NAME }}-${VERSION}-x86_64-unknown-linux-musl
          tar -czvf ${ARCHIVE_NAME}.tar.gz -C $RELEASE_DIR .

          # Generate checksum for the archive
          echo "checksum=$(sha256sum ${ARCHIVE_NAME}.tar.gz | awk '{ print $1 }')" >> $GITHUB_OUTPUT
          
          # Make archive name available to other steps
          echo "archive_name=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.archive_name }}
          body: |
            Release for version ${{ github.ref_name }}
            
            **Checksum (SHA256):**
            ```
            ${{ steps.package.outputs.checksum }}
            ```
          draft: false
          prerelease: false
